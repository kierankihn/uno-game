import { VerticalBox, HorizontalBox, ScrollView } from "std-widgets.slint";
import { Button } from "Components.slint";

// å¡ç‰Œé¢œè‰²æšä¸¾
export enum CardColor {
    Red,
    Blue,
    Green,
    Yellow
}

// æ¸¸æˆæ–¹å‘æšä¸¾
export enum GameDirection {
    Clockwise,
    CounterClockwise
}

// å…¶ä»–ç©å®¶ä¿¡æ¯ç»“æ„
export struct OtherPlayer {
    name: string,
    card-count: int,
    has-uno: bool,
    is-current-turn: bool,
}

// æ‰‹ç‰Œä¿¡æ¯ç»“æ„
export struct HandCard {
    image-path: image,
    is-selected: bool,
    card-id: int,
    is-wild: bool,
    can-be-played: bool,
}

// ç©å®¶å¤´åƒç»„ä»¶
component PlayerAvatar inherits Rectangle {
    in property <string> player-name;
    in property <int> card-count;
    in property <bool> has-uno;
    in property <bool> is-current-turn;
    width: 100px;
    height: 130px;
    background: transparent;
    VerticalLayout {
        spacing: 4px;
        alignment: center;

        // UNO æ ‡å¿—å ä½åŒºåŸŸ (å›ºå®šé«˜åº¦)
        HorizontalLayout {
            alignment: center;
            Rectangle {
                width: 50px;
                height: 20px;
                background: has-uno ? #FF5722 : transparent;
                border-radius: 4px;
                Text {
                    text: "UNO!";
                    font-size: 11px;
                    font-weight: 700;
                    color: has-uno ? #FFFFFF : transparent;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
            }
        }

        // å¤´åƒ
        HorizontalLayout {
            alignment: center;
            Rectangle {
                width: 60px;
                height: 60px;
                background: is-current-turn ? #FFD54F : #E0E0E0;
                border-radius: 30px;
                border-width: is-current-turn ? 3px : 0px;
                border-color: #FF9800;
                Text {
                    text: "ğŸ‘¤";
                    font-size: 28px;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
            }
        }

        // ç©å®¶åç§°
        Text {
            text: player-name;
            font-size: 12px;
            font-weight: 500;
            color: #333333;
            horizontal-alignment: center;
        }

        // å‰©ä½™æ‰‹ç‰Œæ•°
        Text {
            text: "å‰©ä½™: " + card-count + " å¼ ";
            font-size: 10px;
            color: #666666;
            horizontal-alignment: center;
        }
    }
}

// å¡ç‰ŒèƒŒé¢ç»„ä»¶ (èµ·ç‰Œå †)
component CardBack inherits Rectangle {
    in property <int> card-width: 100;
    in property <int> card-height: 150;
    width: card-width * 1px;
    height: card-height * 1px;
    background: #2C2C2C;
    border-radius: 10px;
    border-width: 2px;
    border-color: #444444;
    Rectangle {
        width: parent.width * 0.75;
        height: parent.height * 0.83;
        background: #1a1a1a;
        border-radius: 8px;
        Text {
            text: "UNO";
            font-size: 20px;
            font-weight: 700;
            color: #888888;
            horizontal-alignment: center;
            vertical-alignment: center;
        }
    }
}

// å¼ƒç‰Œå †å¡ç‰Œç»„ä»¶
component DiscardCard inherits Rectangle {
    in property <image> card-image;
    in property <int> card-width: 100;
    in property <int> card-height: 150;
    width: card-width * 1px;
    height: card-height * 1px;
    background: transparent;
    border-radius: 10px;
    drop-shadow-blur: 12px;
    drop-shadow-color: #00000040;
    drop-shadow-offset-y: 4px;
    Image {
        width: 100%;
        height: 100%;
        source: card-image;
        image-fit: contain;
    }
}

// æ–¹å‘ç¯èƒŒæ™¯ç»„ä»¶ - åªç»˜åˆ¶ç¯çº¿
component DirectionRingBackground inherits Rectangle {
    in property <CardColor> current-color: CardColor.Red;
    in property <int> ring-width: 500;
    in property <int> ring-height: 280;
    property <color> ring-color: current-color == CardColor.Red ? #F44336 : current-color == CardColor.Blue ? #2196F3 : current-color == CardColor.Green ? #4CAF50 : current-color == CardColor.Yellow ? #FFEB3B : #9E9E9E;
    property <color> ring-color-dim: current-color == CardColor.Red ? #E57373 : current-color == CardColor.Blue ? #64B5F6 : current-color == CardColor.Green ? #81C784 : current-color == CardColor.Yellow ? #FFF176 : #BDBDBD;
    property <float> a: ring-width / 2;
    property <float> b: ring-height / 2;
    width: ring-width * 1px;
    height: ring-height * 1px;
    background: transparent;

    // åº•å±‚å…‰æ™•ç¯
    Path {
        width: 100%;
        height: 100%;
        stroke: ring-color-dim;
        stroke-width: 8px;
        fill: transparent;
        opacity: 0.3;
        MoveTo {
            x: ring-width / 2 + a;
            y: ring-height / 2;
        }

        ArcTo {
            x: ring-width / 2 - a;
            y: ring-height / 2;
            radius-x: a;
            radius-y: b;
            sweep: true;
            large-arc: true;
        }

        ArcTo {
            x: ring-width / 2 + a;
            y: ring-height / 2;
            radius-x: a;
            radius-y: b;
            sweep: true;
            large-arc: true;
        }
    }

    // ä¸»ç¯
    Path {
        width: 100%;
        height: 100%;
        stroke: ring-color;
        stroke-width: 3px;
        fill: transparent;
        opacity: 0.9;
        MoveTo {
            x: ring-width / 2 + a;
            y: ring-height / 2;
        }

        ArcTo {
            x: ring-width / 2 - a;
            y: ring-height / 2;
            radius-x: a;
            radius-y: b;
            sweep: true;
            large-arc: true;
        }

        ArcTo {
            x: ring-width / 2 + a;
            y: ring-height / 2;
            radius-x: a;
            radius-y: b;
            sweep: true;
            large-arc: true;
        }
    }
}

// æ–¹å‘ç¯å…‰ç‚¹ç»„ä»¶ - ä½¿ç”¨å†…ç½®åŠ¨ç”»å®ç°å¹³æ»‘ç§»åŠ¨
component DirectionRingOrbs inherits Rectangle {
    in property <GameDirection> direction: GameDirection.Clockwise;
    in property <CardColor> current-color: CardColor.Red;
    in property <int> ring-width: 500;
    in property <int> ring-height: 280;

    // å•ä¸€çš„åŠ¨ç”»è®¡æ•°å™¨ï¼ŒæŒç»­é€’å¢
    in-out property <int> cycle: 0;
    property <color> ring-color: current-color == CardColor.Red ? #F44336 : current-color == CardColor.Blue ? #2196F3 : current-color == CardColor.Green ? #4CAF50 : current-color == CardColor.Yellow ? #FFEB3B : #9E9E9E;
    property <float> a: ring-width / 2;
    property <float> b: ring-height / 2;

    // åŸºç¡€è§’åº¦ï¼ˆæŒç»­å¢åŠ ï¼‰
    property <float> base-angle: cycle * 360;
    animate base-angle {
        duration: 8s;
        easing: linear;
    }

    // æ–¹å‘ç³»æ•°ï¼šé¡ºæ—¶é’ˆä¸º1ï¼Œé€†æ—¶é’ˆä¸º-1
    property <float> dir-sign: direction == GameDirection.Clockwise ? 1 : -1;

    // å®é™…è§’åº¦ = åŸºç¡€è§’åº¦ * æ–¹å‘ç³»æ•°
    property <float> actual-angle: base-angle * dir-sign;
    width: ring-width * 1px;
    height: ring-height * 1px;
    background: transparent;

    // å…‰ç‚¹1
    Rectangle {
        x: parent.width / 2 - 9px + cos(actual-angle * 1deg) * a * 1px;
        y: parent.height / 2 - 9px + sin(actual-angle * 1deg) * b * 1px;
        width: 18px;
        height: 18px;
        background: ring-color;
        border-radius: 9px;
        drop-shadow-blur: 8px;
        drop-shadow-color: ring-color;
    }

    // å…‰ç‚¹2
    Rectangle {
        x: parent.width / 2 - 9px + cos((actual-angle + 90) * 1deg) * a * 1px;
        y: parent.height / 2 - 9px + sin((actual-angle + 90) * 1deg) * b * 1px;
        width: 18px;
        height: 18px;
        background: ring-color;
        border-radius: 9px;
        drop-shadow-blur: 8px;
        drop-shadow-color: ring-color;
    }

    // å…‰ç‚¹3
    Rectangle {
        x: parent.width / 2 - 9px + cos((actual-angle + 180) * 1deg) * a * 1px;
        y: parent.height / 2 - 9px + sin((actual-angle + 180) * 1deg) * b * 1px;
        width: 18px;
        height: 18px;
        background: ring-color;
        border-radius: 9px;
        drop-shadow-blur: 8px;
        drop-shadow-color: ring-color;
    }

    // å…‰ç‚¹4
    Rectangle {
        x: parent.width / 2 - 9px + cos((actual-angle + 270) * 1deg) * a * 1px;
        y: parent.height / 2 - 9px + sin((actual-angle + 270) * 1deg) * b * 1px;
        width: 18px;
        height: 18px;
        background: ring-color;
        border-radius: 9px;
        drop-shadow-blur: 8px;
        drop-shadow-color: ring-color;
    }

    // é€’å¢è®¡æ•°å™¨
    Timer {
        interval: 8s;
        running: true;
        triggered => {
            cycle = cycle + 1;
        }
    }

    // åˆå§‹åŒ–æ—¶å¯åŠ¨åŠ¨ç”»
    init => {
        cycle = 1;
    }
}

// æ‰‹ç‰Œå¡ç‰Œç»„ä»¶
component HandCardItem inherits Rectangle {
    in property <image> card-image;
    in property <bool> is-selected: false;
    callback clicked;
    width: 120px;
    height: 180px;
    y: is-selected ? -25px : 0px;
    background: transparent;
    border-radius: 10px;
    drop-shadow-blur: is-selected ? 16px : 6px;
    drop-shadow-color: is-selected ? #00000040 : #00000025;
    drop-shadow-offset-y: is-selected ? 6px : 3px;
    animate y {
        duration: 150ms;
        easing: ease-out;
    }
    animate drop-shadow-blur { duration: 150ms; }
    touch := TouchArea {
        clicked => {
            root.clicked();
        }
    }

    Image {
        width: 100%;
        height: 100%;
        source: card-image;
        image-fit: contain;
    }
}

// UNO åœ†å½¢æŒ‰é’®ç»„ä»¶
component UnoButton inherits Rectangle {
    callback clicked;
    width: 90px;
    height: 90px;
    background: touch.pressed ? #D32F2F : #F44336;
    border-radius: 45px;
    drop-shadow-blur: 12px;
    drop-shadow-color: #F4433660;
    drop-shadow-offset-y: 4px;
    touch := TouchArea {
        clicked => {
            root.clicked();
        }
    }

    Text {
        text: "UNO!";
        font-size: 20px;
        font-weight: 700;
        color: #FFFFFF;
        horizontal-alignment: center;
        vertical-alignment: center;
    }
}

// é¢œè‰²é€‰æ‹©æŒ‰é’®ç»„ä»¶
component ColorButton inherits Rectangle {
    in property <color> btn-color;
    in property <string> color-name;
    callback clicked;
    width: 80px;
    height: 80px;
    background: touch.pressed ? btn-color.darker(20%) : btn-color;
    border-radius: 12px;
    border-width: 3px;
    border-color: btn-color.darker(30%);
    drop-shadow-blur: 8px;
    drop-shadow-color: btn-color.with-alpha(0.4);
    drop-shadow-offset-y: 3px;
    touch := TouchArea {
        clicked => {
            root.clicked();
        }
    }

    Text {
        text: color-name;
        font-size: 14px;
        font-weight: 600;
        color: #FFFFFF;
        horizontal-alignment: center;
        vertical-alignment: center;
    }
}

// é¢œè‰²é€‰æ‹©å¼¹çª—ç»„ä»¶
component ColorPickerDialog inherits Rectangle {
    in property <bool> show: false;
    callback color-selected(CardColor);
    callback cancel;
    width: 100%;
    height: 100%;
    background: show ? #00000080 : transparent;
    opacity: show ? 1.0 : 0.0;
    visible: show;
    animate opacity {
        duration: 200ms;
        easing: ease-out;
    }
    
    // é˜»æ­¢ç‚¹å‡»ç©¿é€
    TouchArea {
        enabled: show;
        clicked => {
            root.cancel();
        }
    }
    
    // å¼¹çª—å†…å®¹
    Rectangle {
        x: (parent.width - self.width) / 2;
        y: (parent.height - self.height) / 2;
        width: 600px;
        height: 280px;
        background: #FFFFFF;
        border-radius: 20px;
        drop-shadow-blur: 30px;
        drop-shadow-color: #00000040;
        drop-shadow-offset-y: 10px;
        
        // é˜»æ­¢ç‚¹å‡»å¼¹çª—å†…å®¹æ—¶å…³é—­
        TouchArea {
            enabled: show;
        }

        VerticalLayout {
            padding: 30px;
            spacing: 25px;
            alignment: center;
            
            // æ ‡é¢˜
            Text {
                text: "é€‰æ‹©é¢œè‰²";
                font-size: 24px;
                font-weight: 700;
                color: #333333;
                horizontal-alignment: center;
            }
            
            // é¢œè‰²æŒ‰é’®ç½‘æ ¼
            HorizontalLayout {
                spacing: 20px;
                alignment: center;
                ColorButton {
                    btn-color: #F44336;
                    color-name: "çº¢è‰²";
                    clicked => {
                        root.color-selected(CardColor.Red);
                    }
                }

                ColorButton {
                    btn-color: #2196F3;
                    color-name: "è“è‰²";
                    clicked => {
                        root.color-selected(CardColor.Blue);
                    }
                }

                ColorButton {
                    btn-color: #4CAF50;
                    color-name: "ç»¿è‰²";
                    clicked => {
                        root.color-selected(CardColor.Green);
                    }
                }

                ColorButton {
                    btn-color: #FFEB3B;
                    color-name: "é»„è‰²";
                    clicked => {
                        root.color-selected(CardColor.Yellow);
                    }
                }
            }
            
            // å–æ¶ˆæŒ‰é’®
            HorizontalLayout {
                alignment: center;
                Button {
                    text: "å–æ¶ˆ";
                    clicked => {
                        root.cancel();
                    }
                }
            }
        }
    }
}

// ä¸»æ¸¸æˆé¡µé¢
export component GamePage inherits Window {
    // å…¶ä»–ç©å®¶åˆ—è¡¨
    in property <[OtherPlayer]> other-players;

    // å½“å‰ç©å®¶ä¿¡æ¯
    in property <string> current-player-name;
    in property <int> current-player-card-count;
    in property <bool> current-player-has-uno;
    in property <bool> is-current-player-turn;

    // æ‰‹ç‰Œåˆ—è¡¨
    in property <[HandCard]> hand-cards;

    // å½“å‰é€‰ä¸­çš„å¡ç‰Œç´¢å¼• (-1 è¡¨ç¤ºæœªé€‰ä¸­)
    property <int> selected-card-index: -1;

    // å¼ƒç‰Œå †é¡¶ç‰Œ
    in property <image> discard-top-card;

    // æ¸¸æˆçŠ¶æ€
    in property <GameDirection> game-direction;
    in property <CardColor> current-color;

    // é¢œè‰²é€‰æ‹©å¼¹çª—çŠ¶æ€
    in-out property <bool> show-color-picker;

    // å›è°ƒ
    callback request-play-card(int, CardColor);
    callback request-draw-card;
    callback request-uno;
    width: 1920px;
    height: 1080px;

    // èƒŒæ™¯æ¸å˜
    Rectangle {
        background: @linear-gradient(135deg, #fdfbf7 0%, #f3e7e9 100%);
    }

    // ä¸»å¸ƒå±€
    VerticalLayout {
        padding: 30px;
        spacing: 20px;

        // ===== é¡¶éƒ¨ï¼šå…¶ä»–ç©å®¶åŒºåŸŸ =====
        Rectangle {
            height: 150px;
            background: #FDFBF8;
            border-radius: 16px;
            drop-shadow-blur: 10px;
            drop-shadow-color: #00000010;
            drop-shadow-offset-y: 2px;
            HorizontalLayout {
                padding-top: 10px;
                padding-bottom: 15px;
                padding-left: 15px;
                padding-right: 15px;
                spacing: 40px;
                alignment: center;
                for player[index] in other-players: PlayerAvatar {
                    player-name: player.name;
                    card-count: player.card-count;
                    has-uno: player.has-uno;
                    is-current-turn: player.is-current-turn;
                }
            }
        }

        // ===== ä¸­é—´ï¼šç‰Œå †åŒºåŸŸ =====
        Rectangle {
            vertical-stretch: 1;
            background: transparent;

            // ä¸­å¿ƒå®¹å™¨ï¼šåŒ…å«ç¯å’Œä¸¤ä¸ªç‰Œå †
            Rectangle {
                width: 560px;
                height: 320px;
                x: (parent.width - self.width) / 2;
                y: (parent.height - self.height) / 2;
                background: transparent;

                // æ–¹å‘ç¯èƒŒæ™¯ - åœ¨ç‰Œå †ä¸‹é¢
                DirectionRingBackground {
                    x: (parent.width - self.width) / 2;
                    y: (parent.height - self.height) / 2;
                    ring-width: 560;
                    ring-height: 320;
                    current-color: root.current-color;
                }

                // èµ·ç‰Œå † - å·¦ä¾§
                Rectangle {
                    x: 80px;
                    y: (parent.height - 200px) / 2;
                    width: 130px;
                    height: 200px;
                    CardBack {
                        card-width: 130;
                        card-height: 200;
                    }

                    TouchArea {
                        enabled: root.is-current-player-turn;
                        width: parent.width;
                        height: parent.height;
                        clicked => {
                            root.request-draw-card();
                        }
                    }
                }

                // å¼ƒç‰Œå † - å³ä¾§
                DiscardCard {
                    x: parent.width - 130px - 80px;
                    y: (parent.height - 200px) / 2;
                    card-width: 130;
                    card-height: 200;
                    card-image: root.discard-top-card;
                }

                // æ–¹å‘ç¯å…‰ç‚¹ - åœ¨ç‰Œå †ä¸Šé¢
               DirectionRingOrbs {
                    x: (parent.width - self.width) / 2;
                    y: (parent.height - self.height) / 2;
                    ring-width: 560;
                    ring-height: 320;
                    direction: root.game-direction;
                    current-color: root.current-color;
                }
            }
        }

        // ===== åº•éƒ¨ï¼šå½“å‰ç©å®¶åŒºåŸŸ =====
        Rectangle {
            height: 320px;
            background: #FDFBF8;
            border-radius: 16px;
            drop-shadow-blur: 10px;
            drop-shadow-color: #00000010;
            drop-shadow-offset-y: -2px;
            HorizontalLayout {
                padding: 20px;
                padding-left: 40px;
                padding-right: 40px;
                spacing: 30px;
                alignment: space-between;

                // å½“å‰ç©å®¶å¤´åƒ - é å·¦ï¼Œå‚ç›´å±…ä¸­ä¸UNOæŒ‰é’®å¯¹é½
                VerticalLayout {
                    alignment: center;
                    PlayerAvatar {
                        player-name: current-player-name;
                        card-count: current-player-card-count;
                        has-uno: current-player-has-uno;
                        is-current-turn: is-current-player-turn;
                    }
                }

                // æ‰‹ç‰ŒåŒºåŸŸ
                VerticalLayout {
                    horizontal-stretch: 1;
                    spacing: 10px;
                    alignment: center;

                    // å‡ºç‰ŒæŒ‰é’® (æ”¾åœ¨æ‰‹ç‰Œä¸Šæ–¹)
                    Rectangle {
                        height: 50px;
                        background: transparent;
                        HorizontalLayout {
                            alignment: center;
                            padding-bottom: 10px;
                            Button {
                                text: "å‡ºç‰Œ";
                                enabled: is-current-player-turn && selected-card-index >= 0 && hand-cards[selected-card-index].can-be-played;
                                clicked => {
                                    if (selected-card-index >= 0) {
                                        // æ£€æŸ¥æ˜¯å¦æ˜¯ä¸‡èƒ½ç‰Œ
                                        if (hand-cards[selected-card-index].is-wild) {
                                             // æ˜¾ç¤ºé¢œè‰²é€‰æ‹©å¼¹çª—
                                             root.show-color-picker = true;
                                        } else {
                                            // éä¸‡èƒ½ç‰Œç›´æ¥å‡ºç‰Œï¼Œé¢œè‰²ä¼  Red
                                            root.request-play-card(selected-card-index, CardColor.Red);
                                            selected-card-index = -1;
                                        }
                                    }
                                }
                            }
                        }
                    }

                    // æ‰‹ç‰Œåˆ—è¡¨ - ä¸Šæ–¹ç•™å‡ºç©ºé—´ç»™é€‰ä¸­æ•ˆæœ
                    Rectangle {
                        height: 210px;
                        background: transparent;

                        // æ‰‹ç‰Œå®¹å™¨ï¼Œå‘ä¸‹åç§»ä»¥ç»™é€‰ä¸­å¡ç‰Œç•™ç©ºé—´ï¼Œå±…ä¸­æ˜¾ç¤º
                        Rectangle {
                            x: (parent.width - self.width) / 2;
                            y: 25px;
                            width: hand-cards-layout.preferred-width;
                            height: 180px;
                            hand-cards-layout := HorizontalLayout {
                                alignment: center;
                                spacing: -35px; // å¡ç‰Œé‡å æ•ˆæœ

                                for card[index] in hand-cards: HandCardItem {
                                    card-image: card.image-path;
                                    is-selected: index == selected-card-index;
                                    clicked => {
                                        if (is-current-player-turn && card.can-be-played) {
                                             // åˆ‡æ¢é€‰ä¸­çŠ¶æ€
                                            if (selected-card-index == index) {
                                                selected-card-index = -1;
                                            } else {
                                                selected-card-index = index;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                // UNO æŒ‰é’® - é å³
                VerticalLayout {
                    alignment: center;
                    UnoButton {
                        clicked => {
                            root.request-uno();
                        }
                    }
                }
            }
        }
    }

    // é¢œè‰²é€‰æ‹©å¼¹çª— (è¦†ç›–åœ¨æœ€ä¸Šå±‚)
    ColorPickerDialog {
        show: root.show-color-picker;
        color-selected(color) => {
            root.show-color-picker = false;
            root.request-play-card(selected-card-index, color);
            selected-card-index = -1;
        }
        cancel => {
            root.show-color-picker = false;
        }
    }
}
